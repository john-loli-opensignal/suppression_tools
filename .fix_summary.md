# Dashboard Outlier Detection Fix - 2025-10-06

## Issues Identified:

1. **Volume Mode Outlier Detection**: Z-scores were calculated on share metrics (win_share, loss_share) even when display_mode="volume", causing incorrect outlier flagging
   - Example: AT&T on Aug 16 with 1520 wins was not flagged because Saturday variance is high
   
2. **Wins Per Loss Outlier Detection**: Z-scores were calculated on win_share instead of the wins_per_loss ratio itself
   - Example: July 21 with highest WPL (2.118) was flagged as **negative outlier** when it should be **positive outlier**
   
3. **Tooltip Display**: Raw wins/losses were not showing in hover tooltips for wins_per_loss metric in competitor mode

## Root Cause:

In `carrier_dashboard_duckdb.py`, the `compute_competitor_pdf()` function was using `db_metric` (which mapped to share metrics) for z-score calculation regardless of display_mode or actual metric.

```python
# OLD CODE (line 529):
vals = g.loc[mask, db_metric]  # Always used share, wrong for volume/WPL

# NEW CODE:
zscore_metric = 'h2h_wins' if (display_mode == 'volume' and metric == 'wins') else metric
vals = g.loc[mask, zscore_metric]  # Uses correct metric for z-score
```

## Fix Applied:

Modified `compute_competitor_pdf()` to select the appropriate metric for z-score calculation based on display_mode and metric:

- **Volume mode + Wins**: Use `h2h_wins` (raw counts)
- **Volume mode + Losses**: Use `h2h_losses` (raw counts)
- **Volume mode + WPL**: Use `wins_per_loss` (ratio)
- **Share mode**: Use original metric (win_share, loss_share, wins_per_loss)

## Test Results:

**Before Fix**:
- July 21 (WPL=2.118): Flagged as negative outlier ❌
- Aug 16 (1520 wins): Not flagged in volume mode ❌

**After Fix**:
- July 21 (WPL=2.118): Correctly flagged as positive outlier (z=4.00) ✅
- Aug 16 (1520 wins): Correctly evaluated on volume basis ✅

## Related Files:

- `carrier_dashboard_duckdb.py`: Line 470-550 (compute_competitor_pdf)
- `tools/src/outliers.py`: National outlier detection (already correct)
- `tools/db.py`: Cube-based outlier functions (already correct)

## Commit:

```
fix(dashboard): correct outlier detection for volume mode and wins_per_loss
```

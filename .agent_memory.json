{
  "streamlit_api_changes": {
    "use_container_width_deprecation": {
      "date": "2025-10-05",
      "change": "Streamlit 1.50.0 deprecated use_container_width parameter",
      "fix": "Replace use_container_width=True with width='stretch', use_container_width=False with width='content'",
      "affected_methods": [
        "st.plotly_chart()",
        "st.dataframe()"
      ],
      "commit": "33263dc"
    }
  },
  "critical_fixes": {
    "windstream_suppression_bug": {
      "date": "2025-10-05",
      "problem": "Windstream had 437 wins to remove but only 37 were suppressed (8.5%)",
      "root_cause": "Hardcoded 5-win minimum for auto suppression was too high for carriers with many small DMA pairs (1-2 wins each)",
      "solution": "Made auto_min_wins configurable (slider, default: 2). Lowered distributed_min_wins default to 1.",
      "key_insight": "Different carriers have different pair distributions. Large carriers (AT&T) have concentrated pairs (100+ wins). Small carriers (Windstream) have distributed pairs (1-5 wins). Hardcoded thresholds fail for one or the other.",
      "commit": "c520b1c",
      "file": "analysis/windstream_debug_analysis.md"
    }
  },
  "suppression_thresholds": {
    "auto_min_wins": {
      "default": 2,
      "range": "1-20",
      "purpose": "Minimum current wins for a pair to be eligible for auto suppression (outliers, first appearance, rare pairs)",
      "guidance": "Lower for small carriers with distributed volume (Windstream, Hughes). Keep at 2-5 for large carriers."
    },
    "distributed_min_wins": {
      "default": 1,
      "range": "1-50",
      "purpose": "Minimum current wins for a pair to receive distributed suppression",
      "guidance": "Keep at 1 to ensure all pairs can participate in distribution. Raise to 2-5 if you want to ignore very small pairs."
    },
    "z_threshold": {
      "default": 2.5,
      "range": "0.5-5.0",
      "purpose": "Z-score threshold for statistical outliers",
      "guidance": "2.5 is standard (99% confidence). Lower to 1.5-2.0 for more aggressive suppression."
    },
    "egregious_threshold": {
      "default": 40,
      "range": "10-100",
      "purpose": "Flag outliers outside top-N carriers if impact exceeds this",
      "guidance": "40 wins is ~5% of typical daily volume. Catches major anomalies even in tail carriers."
    }
  },
  "carrier_characteristics": {
    "large_concentrated": {
      "examples": [
        "AT&T",
        "Verizon",
        "T-Mobile",
        "Spectrum"
      ],
      "pair_pattern": "Few DMAs, high volume per pair (50-200 wins)",
      "outlier_pattern": "Single pair spikes dominate national outliers",
      "threshold_recommendations": {
        "auto_min_wins": "2-5",
        "distributed_min_wins": "5-10"
      }
    },
    "small_distributed": {
      "examples": [
        "Windstream",
        "Hughes",
        "Consolidated"
      ],
      "pair_pattern": "Many DMAs, low volume per pair (1-5 wins)",
      "outlier_pattern": "National outliers from cumulative effect of many small pair spikes",
      "threshold_recommendations": {
        "auto_min_wins": "1-2",
        "distributed_min_wins": "1"
      }
    }
  },
  "preagg_version_support": {
    "v15_0": {
      "census_vintage": "2020",
      "path_pattern": "~/tmp/platform_pre_agg_v_15_0/{date}/{uuid}/",
      "blockid_col": "primary_geoid",
      "crosswalk": "ref/cb_cw_2020",
      "crosswalk_join_key": "census_blockid",
      "date_format": "INT32",
      "has_ds_column": true,
      "column_count": 35,
      "default_db": "data/databases/duck_suppression.db"
    },
    "v0_3": {
      "census_vintage": "2010",
      "path_pattern": "~/tmp/platform_pre_aggregate_v_0_3/{ds}/{date}/{uuid}/",
      "blockid_col": "census_blockid",
      "crosswalk": "ref/d_census_block_crosswalk",
      "crosswalk_join_key": "serv_terr_blockid",
      "date_format": "BYTE_ARRAY",
      "has_ds_column": "sometimes (extract from path if missing)",
      "column_count": 21,
      "default_db": "data/databases/duck_suppression_v03.db"
    },
    "build_script": {
      "path": "scripts/build/build_suppression_db.py",
      "auto_detects_version": true,
      "detect_only_flag": "--detect-only",
      "example_v15": "uv run python scripts/build/build_suppression_db.py ~/tmp/platform_pre_agg_v_15_0/2025-09-26/{uuid}",
      "example_v03": "uv run python scripts/build/build_suppression_db.py ~/tmp/platform_pre_aggregate_v_0_3/gamoshi/2025-10-06/{uuid} --geo ref/d_census_block_crosswalk -o data/databases/duck_suppression_v03.db",
      "saves_build_config": true,
      "config_pattern": "*_build_config.json"
    },
    "key_differences": [
      "v0.3 uses 2010 census blocks, v15.0 uses 2020 census blocks",
      "Cannot directly compare at census block level (different geographies)",
      "Aggregate to DMA level for cross-version comparisons",
      "Both normalize to same carrier_data table schema",
      "Cube builders and dashboards work with both versions"
    ]
  },
  "outlier_detection": {
    "two_different_algorithms": {
      "carrier_dashboard_duckdb": {
        "function": "db.national_outliers_from_cube()",
        "day_grouping": "3 types (Sat/Sun/Weekday)",
        "window_strategy": "Fixed single window (e.g., 14 days)",
        "rolling_scope": "Within specified window only",
        "carrier_scope": "All carriers",
        "use_case": "Exploratory analysis, fast visualization",
        "location": "tools/db.py::national_outliers_from_cube()"
      },
      "main_py_suppression_tool": {
        "function": "scan_base_outliers()",
        "day_grouping": "7 types (DOW 1-7 for each day of week)",
        "window_strategy": "Tiered: tries 28d \u2192 14d \u2192 4d based on data availability",
        "rolling_scope": "Entire time series, then filter to graph window",
        "carrier_scope": "Top N carriers + egregious outliers (impact > threshold)",
        "additional_filters": "Optional minimum share % threshold",
        "use_case": "Production suppression planning, robust to sparse data",
        "location": "tools/src/plan.py::scan_base_outliers()"
      },
      "why_different_results": "Intentional - they serve different purposes. carrier_dashboard for exploration, main.py for production suppression.",
      "alignment_not_needed": "Recommended to keep them different"
    },
    "configurable_thresholds": {
      "national_level": {
        "z_score": {
          "default": 2.5,
          "range": "0.5 to 5.0",
          "location": "main.py sidebar slider: 'National Z-Score Threshold'"
        },
        "egregious_impact": {
          "default": 40,
          "range": "10 to 100",
          "description": "Flags outliers outside top N",
          "location": "main.py sidebar slider: 'Egregious Impact'"
        }
      },
      "dma_pair_level": {
        "z_score": {
          "default": 1.5,
          "range": "0.5 to 5.0",
          "location": "main.py sidebar slider: 'DMA Z-Score Threshold'",
          "usage": "build_enriched_cube(dma_z_threshold=...)"
        },
        "pct_change": {
          "default": 30.0,
          "range": "10.0 to 100.0",
          "location": "main.py sidebar slider: 'DMA % Change Threshold'",
          "usage": "build_enriched_cube(dma_pct_threshold=...)"
        },
        "rare_pair_impact": {
          "default": 15,
          "range": "5 to 50",
          "description": "Minimum impact for rare pairs (appearance_rank <= 5)",
          "location": "main.py sidebar slider: 'Rare Pair Impact'",
          "usage": "build_enriched_cube(rare_pair_impact_threshold=...)"
        }
      }
    },
    "dow_aware_rolling_windows": {
      "tiered_logic": {
        "28d_window": "Weekday: needs 4+ DOW samples, Weekend: needs 2+ DOW samples",
        "14d_window": "Same requirements as fallback",
        "4d_window": "Minimum threshold as last resort",
        "description": "Tries longest window first, falls back to shorter if insufficient data"
      },
      "dow_definition": "1=Sunday, 2=Monday, ..., 7=Saturday (DuckDB DAYOFWEEK())",
      "verified": "Aug 3, 2025 is Sunday (dow=1) \u2705"
    }
  },
  "dashboard_enhancements": {
    "carrier_dashboard_duckdb_improvements": {
      "date": "2025-10-06",
      "commit": "3d320f0",
      "features": {
        "volume_share_toggle": {
          "description": "Toggle between share (%) and volume (count) display",
          "location": "Sidebar radio button below metric selection",
          "default": "share",
          "affects": [
            "y-axis labels",
            "chart title",
            "display values"
          ]
        },
        "enhanced_tooltips": {
          "wins_per_loss": "Shows actual Wins, Losses, Ratio in tooltip",
          "formatting": "Clean HTML with <br> separators, bold carrier names",
          "columns_added": [
            "raw_wins",
            "raw_losses"
          ]
        },
        "collapsible_sections": {
          "carrier_selection": "Expanded by default, contains Top N or Custom selection",
          "display_settings": "Collapsed, contains smoothing, markers, palette, stacked",
          "filters": "Expanded by default, contains mover_ind, ds, state, dma_name",
          "graph_window": "Collapsed, contains start/end date pickers",
          "outliers": "Collapsed, contains window, z-score, show mode"
        },
        "improved_layout": {
          "old_ratio": "[2, 1]",
          "new_ratio": "[12, 1.5]",
          "chart_width_increase": "~8x wider relative to summary",
          "summary_font": "11px via custom CSS",
          "summary_format": "Compact with bullets for competitors"
        }
      },
      "bugs_fixed": [
        "Removed duplicate compute_competitor_pdf() function",
        "Added display_mode to signature tracking",
        "Fixed deprecated use_container_width \u2192 width='stretch'"
      ],
      "documentation": "analysis/competitor_view_enhancements.md"
    }
  },
  "outlier_marker_fixes": {
    "date": "2025-10-06",
    "commit": "1a025f2",
    "problem": "Negative outliers weren't being detected correctly when 'All' mode was selected",
    "root_cause": "Z-score calculation used ABS() which removed the sign, making it impossible to distinguish positive from negative outliers",
    "solution": {
      "z_score_calculation": "Changed from ABS(value - mu) / sigma to (value - mu) / sigma to preserve sign",
      "outlier_detection": "Still uses ABS(z-score) > threshold for detection, so both positive and negative outliers are caught",
      "marker_symbol": "Changed negative outlier marker from 'line-ew' to 'triangle-down' (red) for better visibility"
    },
    "example": "2025-07-21: AT&T vs Cox had z=-3.33 on losses, now correctly flagged and shown with red triangle-down marker",
    "location": "tools/db.py::national_outliers_from_cube() and carrier_dashboard_duckdb.py::create_plot()"
  },
  "recent_fixes": {
    "outlier_direction_parameter": {
      "issue": "NameError: name 'outlier_direction' is not defined in compute_competitor_pdf",
      "root_cause": "outlier_direction was referenced in _z_for_group nested function but not passed as parameter",
      "solution": "Added outlier_direction parameter to compute_competitor_pdf function signature and mapped st.session_state.outlier_show to outlier_direction when calling the function",
      "date": "2025-10-06",
      "commit": "475f946"
    }
  }
}